FROM python:3.12-slim

WORKDIR /app

RUN apt-get update && apt-get install -y \
    git \
    && rm -rf /var/lib/apt/lists/*

COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

COPY pyproject.toml uv.lock ./
# Install deps at build time so K8s pods don't spend time downloading packages on startup.
# Keep the runtime command in the chart compatible (it currently uses `uv run --frozen`).
RUN uv sync --no-dev
# Ensure Phoenix tracing deps are present for observability in production.
# (Some lockfiles may not include them yet; this makes the image robust.)
RUN uv pip install --python /app/.venv/bin/python \
    "arize-phoenix>=12.0.0" \
    "arize-phoenix-otel>=0.6.0" \
    "astor>=0.8.1" \
    "toml>=0.10.2"
RUN /app/.venv/bin/python -c "from phoenix.otel import register; import astor, toml; assert callable(register)"

COPY app ./app
COPY worker ./worker

ENV PATH="/app/.venv/bin:$PATH"
CMD ["python", "-m", "worker.k8s_build_worker"]
